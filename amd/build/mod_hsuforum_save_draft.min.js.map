{"version":3,"sources":["../src/mod_hsuforum_save_draft.js"],"names":["define","$","autoSave","forumid","discussionid","postid","text","userid","ajax","url","method","data","dataType","fetchAutoSave","draftrestorearea","success","html","init","timer","pageloadclick","on","parent","closest","attr","find","interval","setInterval","length","clearInterval","not","e","hasOwnProperty","preventDefault","document","isfooter","clearTimeout","setTimeout"],"mappings":"AAAAA,OAAM,wCAAC,CAAC,QAAD,CAAD,CAAa,SAASC,CAAT,CAAY,CAS3B,QAASC,CAAAA,CAAT,CAAkBC,CAAlB,CAA2BC,CAA3B,CAAyCC,CAAzC,CAAiDC,CAAjD,CAAuDC,CAAvD,CAA+D,CAC3D,GAAI,CAAY,EAAX,EAAAJ,CAAO,EAA0B,EAAhB,EAAAC,CAAlB,GAAiD,EAAR,EAAAE,CAAzC,EAAiE,EAAV,EAAAC,CAA3D,CAAyE,CACrEN,CAAC,CAACO,IAAF,CAAO,CACHC,GAAG,CAAE,qBADF,CAEHC,MAAM,CAAE,MAFL,CAGHC,IAAI,CAAE,CACFR,OAAO,CAAEA,CADP,CAEFC,YAAY,CAAEA,CAFZ,CAGFC,MAAM,CAAEA,CAHN,CAIFC,IAAI,CAAEA,CAJJ,CAKFC,MAAM,CAAEA,CALN,CAHH,CAUHK,QAAQ,CAAE,MAVP,CAAP,CAYH,CACJ,CASD,QAASC,CAAAA,CAAT,CAAuBV,CAAvB,CAAgCC,CAAhC,CAA8CC,CAA9C,CAAsDE,CAAtD,CAA8DO,CAA9D,CAAgF,CAC5E,GAAI,CAAY,EAAX,EAAAX,CAAO,EAA0B,EAAhB,EAAAC,CAAjB,EAAiD,EAAV,EAAAC,CAAxC,GAAmE,EAAV,EAAAE,CAA7D,CAA2E,CACvEN,CAAC,CAACO,IAAF,CAAO,CACHC,GAAG,CAAE,oBADF,CAEHC,MAAM,CAAE,KAFL,CAGHC,IAAI,CAAE,CACFR,OAAO,CAAEA,CADP,CAEFC,YAAY,CAAEA,CAFZ,CAGFC,MAAM,CAAEA,CAHN,CAIFE,MAAM,CAAEA,CAJN,CAHH,CASHK,QAAQ,CAAE,MATP,CAUHG,OAAO,CAAE,iBAASJ,CAAT,CAAe,CACpBG,CAAgB,CAACE,IAAjB,CAAsBL,CAAtB,CACH,CAZE,CAAP,CAcH,CACJ,CAED,MAAO,CACHM,IAAI,CAAE,cAASd,CAAT,CAAkBC,CAAlB,CAAgCG,CAAhC,CAAwC,CAC1CN,CAAC,CAAC,UAAW,IACLiB,CAAAA,CADK,CAGLC,CAAa,GAHR,CAMTlB,CAAC,CAAC,sBAAD,CAAD,CAA0BmB,EAA1B,CAA6B,OAA7B,CAAsC,UAAW,IACzCC,CAAAA,CAAM,CAAGpB,CAAC,CAAC,IAAD,CAAD,CAAQqB,OAAR,CAAgB,wBAAhB,CADgC,CAEzCjB,CAAM,CAAGJ,CAAC,CAACoB,CAAD,CAAD,CAAUE,IAAV,CAAe,aAAf,CAFgC,CAGzCT,CAAgB,CAAGb,CAAC,CAACoB,CAAD,CAAD,CAAUG,IAAV,CAAe,+BAAf,CAHsB,CASzCC,CAAQ,CAAGC,WAAW,CAAC,UAAW,CAClC,GAAIZ,CAAgB,CAACa,MAArB,CAA6B,CACzBd,CAAa,CAACV,CAAD,CAAUC,CAAV,CAAwBC,CAAxB,CAAgCE,CAAhC,CAAwCO,CAAxC,CAAb,CACAc,aAAa,CAACH,CAAD,CAChB,CAHD,IAGO,IAAuB,CAAnB,EALO,CAKX,CAA0B,CAC7BG,aAAa,CAACH,CAAD,CAChB,CAEDX,CAAgB,CAAGb,CAAC,CAACoB,CAAD,CAAD,CAAUG,IAAV,CAAe,+BAAf,CACtB,CATyB,CASvB,GATuB,CAU7B,CAnBD,EAqBAvB,CAAC,CAAC,+CAAD,CAAD,CAAmD4B,GAAnD,CAAuD,qBAAvD,EAA8ET,EAA9E,CAAiF,OAAjF,CAA0F,SAASU,CAAT,CAAY,CAIlG,GAAI,CAACA,CAAC,CAACC,cAAF,CAAiB,eAAjB,CAAD,EAAsCZ,CAA1C,CAAyD,CACrDW,CAAC,CAACE,cAAF,GACA,QACH,CAGDb,CAAa,GAAb,CAVkG,GAW9FL,CAAAA,CAAgB,CAAGb,CAAC,CAAC,wBAAD,CAAD,CAA4BuB,IAA5B,CAAiC,+BAAjC,CAX2E,CAiB9FC,CAAQ,CAAGC,WAAW,CAAC,UAAW,CAClC,GAAIZ,CAAgB,CAACa,MAArB,CAA6B,CACzBd,CAAa,CAACV,CAAD,CAAUC,CAAV,CAVR,IAUQ,CAAgCG,CAAhC,CAAwCO,CAAxC,CAAb,CACAc,aAAa,CAACH,CAAD,CAChB,CAHD,IAGO,IAAuB,CAAnB,EALO,CAKX,CAA0B,CAC7BG,aAAa,CAACH,CAAD,CAChB,CAEDX,CAAgB,CAAGb,CAAC,CAAC,wBAAD,CAAD,CAA4BuB,IAA5B,CAAiC,+BAAjC,CACtB,CATyB,CASvB,GATuB,CAU7B,CA3BD,EA+BAvB,CAAC,CAAC,2CAAD,CAAD,CAA6CmB,EAA7C,CAAgD,OAAhD,CAAyD,UAAW,IAE5DN,CAAAA,CAAgB,CAAGb,CAAC,CAAC,iCAAD,CAAD,CAAqCuB,IAArC,CAA0C,+BAA1C,CAFyC,CAQ5DC,CAAQ,CAAGC,WAAW,CAAC,UAAW,CAClC,GAAIZ,CAAgB,CAACa,MAArB,CAA6B,CACzBd,CAAa,CAACV,CAAD,CAAUC,CAAV,CATR,IASQ,CAAgCG,CAAhC,CAAwCO,CAAxC,CAAb,CACAc,aAAa,CAACH,CAAD,CAChB,CAHD,IAGO,IAAuB,CAAnB,EALO,CAKX,CAA0B,CAC7BG,aAAa,CAACH,CAAD,CAChB,CAEDX,CAAgB,CAAGb,CAAC,CAAC,iCAAD,CAAD,CAAqCuB,IAArC,CAA0C,+BAA1C,CACtB,CATyB,CASvB,GATuB,CAU7B,CAlBD,EAqBAvB,CAAC,CAACgC,QAAD,CAAD,CAAYb,EAAZ,CAAe,OAAf,CAAwB,sBAAxB,CAAgD,UAAW,IAEnDc,CAAAA,CAAQ,CAAGjC,CAAC,CAAC,IAAD,CAAD,CAAQqB,OAAR,CAAgB,wBAAhB,EAA0CK,MAFF,CAGnDtB,CAAM,CAAG,IAH0C,CAMvD,GAAI,CAAC6B,CAAL,CAAe,CACX,GAAIb,CAAAA,CAAM,CAAGpB,CAAC,CAAC,IAAD,CAAD,CAAQqB,OAAR,CAAgB,wBAAhB,CAAb,CACAjB,CAAM,CAAGJ,CAAC,CAACoB,CAAD,CAAD,CAAUE,IAAV,CAAe,aAAf,GAAiC,IAA1C,CAEA,GAAe,IAAX,GAAAlB,CAAJ,CAAqB,CACjBgB,CAAM,CAAGpB,CAAC,CAAC,IAAD,CAAD,CAAQqB,OAAR,CAAgB,kBAAhB,CAAT,CACAjB,CAAM,CAAGJ,CAAC,CAACoB,CAAD,CAAD,CAAUE,IAAV,CAAe,aAAf,GAAiC,IAC7C,CACJ,CAED,GAAIjB,CAAAA,CAAI,CAAGL,CAAC,CAAC,IAAD,CAAD,CAAQK,IAAR,EAAX,CAEA,GAAIY,CAAJ,CAAW,CACPiB,YAAY,CAACjB,CAAD,CACf,CAEDA,CAAK,CAAGkB,UAAU,CAAC,UAAW,CAC3BlC,CAAQ,CAACC,CAAD,CAAUC,CAAV,CAAwBC,CAAxB,CAAgCC,CAAhC,CAAsCC,CAAtC,CACV,CAFiB,CAEf,GAFe,CAGrB,CAzBD,CA0BH,CAzGA,CA0GJ,CA5GE,CA8GV,CAlKK,CAAN","sourcesContent":["define(['jquery'], function($) {\n    /**\n     * Makes AJAX call to write current text for forum/discussion/post to DB for restoration later on\n     * @param forumid int\n     * @param discussionid int\n     * @param postid int\n     * @param text string\n     * @param userid int\n     */\n    function autoSave(forumid, discussionid, postid, text, userid) {\n        if ((forumid != '' || discussionid != '') && text != '' && userid != '') {\n            $.ajax({\n                url: \"save_post_draft.php\",\n                method: \"POST\",\n                data: {\n                    forumid: forumid,\n                    discussionid: discussionid,\n                    postid: postid,\n                    text: text,\n                    userid: userid\n                },\n                dataType: \"text\"\n            });\n        }\n    }\n\n    /**\n     * Makes AJAX call to restore draft if it exists\n     * @param forumid\n     * @param discussionid\n     * @param postid\n     * @param userid\n     */\n    function fetchAutoSave(forumid, discussionid, postid, userid, draftrestorearea) {\n        if ((forumid != '' || discussionid != '' || postid != '') && userid != '') {\n            $.ajax({\n                url: \"get_post_draft.php\",\n                method: \"GET\",\n                data: {\n                    forumid: forumid,\n                    discussionid: discussionid,\n                    postid: postid,\n                    userid: userid\n                },\n                dataType: \"text\",\n                success: function(data) {\n                    draftrestorearea.html(data);\n                }\n            });\n        }\n    }\n\n    return {\n        init: function(forumid, discussionid, userid) {\n            $(function() {\n                let timer;\n                // This is to restore the draft when the page loads and programatic click occurs\n                let pageloadclick = false;\n\n                // Bind click to the reply\n                $('.hsuforum-reply-link').on('click', function() {\n                    let parent = $(this).closest('.hsuforum-post-wrapper');\n                    let postid = $(parent).attr('data-postid');\n                    let draftrestorearea = $(parent).find('#hiddenadvancededitoreditable');\n\n                    // Because content is dynamically injected, the draft restore area doesn't exist when we click the\n                    // button, create an interval counter and interval that will cancel interval when draftrestorearea\n                    // found or 5 iterations have passed\n                    let intervalcounter = 0;\n                    let interval = setInterval(function() {\n                        if (draftrestorearea.length) {\n                            fetchAutoSave(forumid, discussionid, postid, userid, draftrestorearea);\n                            clearInterval(interval);\n                        } else if (intervalcounter >= 5) {\n                            clearInterval(interval);\n                        }\n\n                        draftrestorearea = $(parent).find('#hiddenadvancededitoreditable');\n                    }, 200);\n                });\n\n                $('.hsuforum-footer-reply .hsuforum-use-advanced').not('.hideadvancededitor').on('click', function(e) {\n                    // Because we toggle editors programmatically depending on how the users interact with the forum, we\n                    // need to differentiate between programmatic clicks after the initial page load click and genuine\n                    // user interactions. If programmatic after page load, prevent any further execution\n                    if (!e.hasOwnProperty('originalEvent') && pageloadclick) {\n                        e.preventDefault();\n                        return false;\n                    }\n\n                    let postid = null;\n                    pageloadclick = true;\n                    let draftrestorearea = $('.hsuforum-footer-reply').find('#hiddenadvancededitoreditable');\n\n                    // Because content is dynamically injected, the draft restore area doesn't exist when we click the\n                    // button, create an interval counter and interval that will cancel interval when draftrestorearea\n                    // found or 5 iterations have passed\n                    let intervalcounter = 0;\n                    let interval = setInterval(function() {\n                        if (draftrestorearea.length) {\n                            fetchAutoSave(forumid, discussionid, postid, userid, draftrestorearea);\n                            clearInterval(interval);\n                        } else if (intervalcounter >= 5) {\n                            clearInterval(interval);\n                        }\n\n                        draftrestorearea = $('.hsuforum-footer-reply').find('#hiddenadvancededitoreditable');\n                    }, 200);\n                });\n\n\n                // Bind click to new discussion topic button\n                $('#newdiscussionform input[type=\"submit\"]').on('click', function() {\n                    let postid = null;\n                    let draftrestorearea = $('.hsuforum-add-discussion-target').find('#hiddenadvancededitoreditable');\n\n                    // Because content is dynamically injected, the draft restore area doesn't exist when we click the\n                    // button, create an interval counter and interval that will cancel interval when draftrestorearea\n                    // found or 5 iterations have passed\n                    let intervalcounter = 0;\n                    let interval = setInterval(function() {\n                        if (draftrestorearea.length) {\n                            fetchAutoSave(forumid, discussionid, postid, userid, draftrestorearea);\n                            clearInterval(interval);\n                        } else if (intervalcounter >= 5) {\n                            clearInterval(interval);\n                        }\n\n                        draftrestorearea = $('.hsuforum-add-discussion-target').find('#hiddenadvancededitoreditable');\n                    }, 200);\n                });\n\n                // Bind to keyup to trigger autosave\n                $(document).on(\"keyup\", \".editor_atto_content\", function() {\n                    // If there is a the footer reply as a parent, it means that there is no post id\n                    let isfooter = $(this).closest('.hsuforum-footer-reply').length;\n                    let postid = null;\n\n                    // If it is not the footer, it means that there is a post id and we need to find the post id of that parent\n                    if (!isfooter) {\n                        let parent = $(this).closest('.hsuforum-post-wrapper');\n                        postid = $(parent).attr('data-postid') || null;\n\n                        if (postid === null) {\n                            parent = $(this).closest('.hsuforum-thread');\n                            postid = $(parent).attr('data-postid') || null;\n                        }\n                    }\n\n                    let text = $(this).text();\n\n                    if (timer) {\n                        clearTimeout(timer);\n                    }\n\n                    timer = setTimeout(function() {\n                       autoSave(forumid, discussionid, postid, text, userid);\n                    }, 5000); // Wait 5000 milliseconds before triggering event.\n                });\n            });\n        }\n    };\n});\n"],"file":"mod_hsuforum_save_draft.min.js"}