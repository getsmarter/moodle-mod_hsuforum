{"version":3,"sources":["../src/mod_hsuforum_save_draft.js"],"names":["define","autoSave","forumid","discussionid","postid","text","userid","$","ajax","url","method","data","dataType","fetchAutoSave","draftrestorearea","success","html","init","timer","pageloadclick","on","parent","closest","attr","find","interval","setInterval","length","clearInterval","not","e","hasOwnProperty","preventDefault","document","clearTimeout","setTimeout"],"mappings":"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","sourcesContent":["define([], function() {\n    /**\n     * Makes AJAX call to write current text for forum/discussion/post to DB for restoration later on\n     * @param forumid int\n     * @param discussionid int\n     * @param postid int\n     * @param text string\n     * @param userid int\n     */\n    function autoSave(forumid, discussionid, postid, text, userid) {\n        if ((forumid != '' || discussionid != '') && text != '' && userid != '') {\n            $.ajax({\n                url: \"save_post_draft.php\",\n                method: \"POST\",\n                data: {\n                    forumid: forumid,\n                    discussionid: discussionid,\n                    postid: postid,\n                    text: text,\n                    userid: userid\n                },\n                dataType: \"text\"\n            });\n        }\n    }\n\n    /**\n     * Makes AJAX call to restore draft if it exists\n     * @param forumid\n     * @param discussionid\n     * @param postid\n     * @param userid\n     */\n    function fetchAutoSave(forumid, discussionid, postid, userid, draftrestorearea) {\n        if ((forumid != '' || discussionid != '' || postid != '') && userid != '') {\n            $.ajax({\n                url: \"get_post_draft.php\",\n                method: \"GET\",\n                data: {\n                    forumid: forumid,\n                    discussionid: discussionid,\n                    postid: postid,\n                    userid: userid\n                },\n                dataType: \"text\",\n                success: function(data) {\n                    draftrestorearea.html(data);\n                }\n            });\n        }\n    }\n\n    return {\n        init: function(forumid, discussionid, userid) {\n            $(function() {\n                let timer;\n                // This is to restore the draft when the page loads and programatic click occurs\n                let pageloadclick = false;\n\n                // Bind click to the reply\n                $('.hsuforum-reply-link').on('click', function() {\n                    let parent = $(this).closest('.hsuforum-post-wrapper');\n                    let postid = $(parent).attr('data-postid');\n                    let draftrestorearea = $(parent).find('#hiddenadvancededitoreditable');\n\n                    // Because content is dynamically injected, the draft restore area doesn't exist when we click the\n                    // button, create an interval counter and interval that will cancel interval when draftrestorearea\n                    // found or 5 iterations have passed\n                    let intervalcounter = 0;\n                    let interval = setInterval(function() {\n                        if (draftrestorearea.length) {\n                            fetchAutoSave(forumid, discussionid, postid, userid, draftrestorearea);\n                            clearInterval(interval);\n                        } else if (intervalcounter >= 5) {\n                            clearInterval(interval);\n                        }\n\n                        draftrestorearea = $(parent).find('#hiddenadvancededitoreditable');\n                    }, 200);\n                });\n\n                $('.hsuforum-footer-reply .hsuforum-use-advanced').not('.hideadvancededitor').on('click', function(e) {\n                    // Because we toggle editors programmatically depending on how the users interact with the forum, we\n                    // need to differentiate between programmatic clicks after the initial page load click and genuine\n                    // user interactions. If programmatic after page load, prevent any further execution\n                    if (!e.hasOwnProperty('originalEvent') && pageloadclick) {\n                        e.preventDefault();\n                        return false;\n                    }\n\n                    let postid = null;\n                    pageloadclick = true;\n                    let draftrestorearea = $('.hsuforum-footer-reply').find('#hiddenadvancededitoreditable');\n\n                    // Because content is dynamically injected, the draft restore area doesn't exist when we click the\n                    // button, create an interval counter and interval that will cancel interval when draftrestorearea\n                    // found or 5 iterations have passed\n                    let intervalcounter = 0;\n                    let interval = setInterval(function() {\n                        if (draftrestorearea.length) {\n                            fetchAutoSave(forumid, discussionid, postid, userid, draftrestorearea);\n                            clearInterval(interval);\n                        } else if (intervalcounter >= 5) {\n                            clearInterval(interval);\n                        }\n\n                        draftrestorearea = $('.hsuforum-footer-reply').find('#hiddenadvancededitoreditable');\n                    }, 200);\n                });\n\n\n                // Bind click to new discussion topic button\n                $('#newdiscussionform input[type=\"submit\"]').on('click', function() {\n                    let postid = null;\n                    let draftrestorearea = $('.hsuforum-add-discussion-target').find('#hiddenadvancededitoreditable');\n\n                    // Because content is dynamically injected, the draft restore area doesn't exist when we click the\n                    // button, create an interval counter and interval that will cancel interval when draftrestorearea\n                    // found or 5 iterations have passed\n                    let intervalcounter = 0;\n                    let interval = setInterval(function() {\n                        if (draftrestorearea.length) {\n                            fetchAutoSave(forumid, discussionid, postid, userid, draftrestorearea);\n                            clearInterval(interval);\n                        } else if (intervalcounter >= 5) {\n                            clearInterval(interval);\n                        }\n\n                        draftrestorearea = $('.hsuforum-add-discussion-target').find('#hiddenadvancededitoreditable');\n                    }, 200);\n                });\n\n                // Bind to keyup to trigger autosave\n                $(document).on(\"keyup\", \".editor_atto_content\", function() {\n                    let parent = $(this).closest('.hsuforum-post-wrapper');\n                    let postid = $(parent).attr('data-postid') || null;\n                    let text = $(this).text();\n\n                    if (timer) {\n                        clearTimeout(timer);\n                    }\n\n                    timer = setTimeout(function() {\n                       autoSave(forumid, discussionid, postid, text, userid);\n                    }, 5000); // Wait 5000 milliseconds before triggering event.\n                });\n            });\n        }\n    };\n});\n"],"file":"mod_hsuforum_save_draft.min.js"}