{"version":3,"sources":["../src/mod_hsuforum_loader.js"],"names":["define","$","waitForElement","querySelector","timeout","startTime","Date","getTime","Promise","resolve","reject","timer","setInterval","now","document","clearInterval","registerPostsObserver","posts","footerReply","push","each","postObserver","MutationObserver","form","find","postid","closest","data","val","formTextarea","on","text","body","dispatchEvent","spinnerStartEvent","observe","subtree","childList","removeAttagging","change","hide","contents","unwrap","startSpinnerHandler","show","stopSpinnerHandler","registerSpinnerEvents","Event","spinnerStopEvent","window","addEventListener","init","then","prop","hascompleted","location","hash","addClass","attr","animate","scrollTop","offset","top","catch"],"mappings":"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","sourcesContent":["define(['jquery'], function ($) {\n\n    /**\n     * Wait for an element before resolving a promise\n     * @param {String} querySelector - Selector of element to wait for\n     * @param {Integer} timeout - Milliseconds to wait before timing out, or 0 for no timeout\n     */\n    function waitForElement(querySelector, timeout= 0) {\n\n        const startTime = new Date().getTime();\n\n        return new Promise((resolve, reject) => {\n            const timer = setInterval(() => {\n\n                const now = new Date().getTime();\n                if(document.querySelector(querySelector)) {\n                    clearInterval(timer);\n                    resolve();\n                }else if(timeout && now - startTime >= timeout) {\n                    clearInterval(timer);\n                    reject();\n                }\n            }, 100);\n        });\n    }\n\n    /**\n     * Function to observe the post body for a dicsussion thread.\n     *\n     * Description:\n     * ------------\n     * Post reply/edit forms are added to the post body dynamically with php.\n     * We need to watch for content changes in the post body for injected forms (reply/edit) to dispatch spinner events.\n     * Stopping the spinner is tied into the scrolling action which is in local/hsuforum_actions/amd/src/hsuforum_actions.js\n     */\n\n    registerPostsObserver = function() {\n        const posts = $('.hsuforum-post-wrapper');\n\n        // Accounting for root reply box at the bottom of the page\n        const footerReply = $('.hsuforum-footer-reply')[0];\n        if (footerReply != undefined) {\n            posts.push(footerReply);\n        }\n\n        if (posts) {\n            $(posts).each(function(){\n                const postObserver = new MutationObserver(() => {\n                    let form = $(this).find('form');\n                    let postid = $(this).closest(\".hsuforum-post-wrapper\").data('postid');\n                    $(this).closest(\".hsuforum-post-wrapper\").find('input[name=\"reply\"]').val(postid);\n                    if (form) {\n                        let formTextarea = $(form).find('.hsuforum-textarea');\n                        $(form).on('submit', () => {\n                            // Check for form errors\n                            if ($(formTextarea).text() != 0) {\n                                document.body.dispatchEvent(spinnerStartEvent);\n                            }\n                        });\n                    }\n\n                });\n                postObserver.observe(this, {subtree: true, childList: true});\n            });\n            removeAttagging();\n        }\n\n    };\n\n    //ratings on chanfge hide unread\n    $('select.postratingmenu.ratinginput').change(function (){\n        $(this).closest('.hsuforum-post-wrapper').find('span.hsuforum-unreadcount').hide();\n    });\n\n    //remove link from @all tags\n    removeAttagging = function() {\n        $(\"#page-mod-hsuforum-discuss a:contains('@all')\").contents().unwrap();\n    };\n\n    /**\n     * Handler function to start the spinner\n     */\n    startSpinnerHandler = function() {\n        $('#hsuforum-overlay-box').show();\n        $('#hsuforum-loading-container').show();\n    };\n\n    /**\n     * Handler function to stop the spinner\n     */\n    stopSpinnerHandler = function() {\n        $('#hsuforum-overlay-box').hide();\n        $('#hsuforum-loading-container').hide();\n    };\n\n    /**\n     * Function to register custom spinner events and make globally available.\n     */\n    registerSpinnerEvents = function() {\n        const spinnerStartEvent = new Event('spinnerStartEvent');\n        const spinnerStopEvent = new Event('spinnerStopEvent');\n\n        window.spinnerStartEvent = spinnerStartEvent;\n        window.spinnerStopEvent = spinnerStopEvent;\n\n        document.body.addEventListener(\"spinnerStartEvent\", () => {\n            startSpinnerHandler();\n        });\n\n        document.body.addEventListener(\"spinnerStopEvent\", () => {\n            stopSpinnerHandler();\n        });\n    };\n\n    return {\n        init: function () {\n            waitForElement(\"body\", 30000).then(function() {\n                $('.container :input').prop('disabled', false);\n                $('.mod-hsuforum-posts-container').show();\n                $('#hsuforum-loading-container').hide();\n                $('#hsuforum-overlay-box').hide();\n                window.hascompleted = false;\n                var postid = window.location.hash;\n                if (!window.hascompleted) {\n                    if (postid) {\n                        if ($(postid).closest('li').data('depth') > 0) {\n                            $(postid).closest('.posts-collapse-container').addClass('show').find('.posts-collapse-toggle.collapse-bottom').attr('aria-expanded', 'true');\n                        }\n                        $('html,body').animate({scrollTop: $(postid).offset().top - 60}, 1000);\n                    }\n                    window.hascompleted = true;\n                }\n            }).catch(() => {\n                $('.container :input').prop('disabled', false);\n                $('.article').show();\n                $('#hsuforum-loading-container').hide();\n                $('#hsuforum-overlay-box').hide();\n                throw(\"element did not load in 30 seconds\");\n            });\n\n                // Register post observers and custom spinner events.\n                registerPostsObserver();\n                registerSpinnerEvents();\n\n        }\n    };\n});\n"],"file":"mod_hsuforum_loader.min.js"}