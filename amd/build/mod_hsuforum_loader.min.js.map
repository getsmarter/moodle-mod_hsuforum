{"version":3,"sources":["../src/mod_hsuforum_loader.js"],"names":["define","$","waitForElement","querySelector","timeout","startTime","Date","getTime","Promise","resolve","reject","timer","setInterval","now","document","clearInterval","registerPostsObserver","posts","footerReply","push","each","postObserver","MutationObserver","form","find","formTextarea","on","text","body","dispatchEvent","spinnerStartEvent","observe","subtree","childList","removeAttagging","change","closest","hide","contents","unwrap","startSpinnerHandler","show","stopSpinnerHandler","registerSpinnerEvents","Event","spinnerStopEvent","window","addEventListener","console","log","init","then","prop","hascompleted","postid","location","hash","data","addClass","attr","animate","scrollTop","offset","top","catch"],"mappings":"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","sourcesContent":["define(['jquery'], function ($) {\n\n    /**\n     * Wait for an element before resolving a promise\n     * @param {String} querySelector - Selector of element to wait for\n     * @param {Integer} timeout - Milliseconds to wait before timing out, or 0 for no timeout\n     */\n    function waitForElement(querySelector, timeout= 0) {\n\n        const startTime = new Date().getTime();\n\n        return new Promise((resolve, reject) => {\n            const timer = setInterval(() => {\n\n                const now = new Date().getTime();\n                if(document.querySelector(querySelector)) {\n                    clearInterval(timer);\n                    resolve();\n                }else if(timeout && now - startTime >= timeout) {\n                    clearInterval(timer);\n                    reject();\n                }\n            }, 100);\n        });\n    }\n\n    /**\n     * Function to observe the post body for a dicsussion thread.\n     *\n     * Description:\n     * ------------\n     * Post reply/edit forms are added to the post body dynamically with php.\n     * We need to watch for content changes in the post body for injected forms (reply/edit) to dispatch spinner events.\n     * Stopping the spinner is tied into the scrolling action which is in local/hsuforum_actions/amd/src/hsuforum_actions.js\n     */\n\n    registerPostsObserver = function() {\n        const posts = $('.hsuforum-post-wrapper');\n\n        // Accounting for root reply box at the bottom of the page\n        const footerReply = $('.hsuforum-footer-reply')[0];\n        if (footerReply != undefined) {\n            posts.push(footerReply);\n        }\n\n        if (posts) {\n            $(posts).each(function(){\n                const postObserver = new MutationObserver(() => {\n                    let form = $(this).find('form');\n\n                    if (form) {\n                        let formTextarea = $(form).find('.hsuforum-textarea');\n                        $(form).on('submit', () => {\n                            // Check for form errors\n                            if ($(formTextarea).text() != 0) {\n                                document.body.dispatchEvent(spinnerStartEvent);\n                            }\n                        });\n                    }\n\n                });\n                postObserver.observe(this, {subtree: true, childList: true});\n            });\n            removeAttagging();\n        }\n\n    };\n\n    //ratings on chanfge hide unread\n    $('select.postratingmenu.ratinginput').change(function (){\n        $(this).closest('.hsuforum-post-wrapper').find('span.hsuforum-unreadcount').hide();\n    });\n\n    //remove link from @all tags\n    removeAttagging = function() {\n        $(\"#page-mod-hsuforum-discuss a:contains('@all')\").contents().unwrap();\n    };\n\n    /**\n     * Handler function to start the spinner\n     */\n    startSpinnerHandler = function() {\n        $('#hsuforum-overlay-box').show();\n        $('#hsuforum-loading-container').show();\n    };\n\n    /**\n     * Handler function to stop the spinner\n     */\n    stopSpinnerHandler = function() {\n        $('#hsuforum-overlay-box').hide();\n        $('#hsuforum-loading-container').hide();\n    };\n\n    /**\n     * Function to register custom spinner events and make globally available.\n     */\n    registerSpinnerEvents = function() {\n        const spinnerStartEvent = new Event('spinnerStartEvent');\n        const spinnerStopEvent = new Event('spinnerStopEvent');\n\n        window.spinnerStartEvent = spinnerStartEvent;\n        window.spinnerStopEvent = spinnerStopEvent;\n\n        document.body.addEventListener(\"spinnerStartEvent\", () => {\n            startSpinnerHandler();\n        });\n\n        document.body.addEventListener(\"spinnerStopEvent\", () => {\n            stopSpinnerHandler();\n        });\n\n        document.body.addEventListener(\"hsuforumerror\", () => {\n            console.log('POC works');\n        });\n    };\n\n    return {\n        init: function () {\n            waitForElement(\"body\", 30000).then(function() {\n                $('.container :input').prop('disabled', false);\n                $('.mod-hsuforum-posts-container').show();\n                $('#hsuforum-loading-container').hide();\n                $('#hsuforum-overlay-box').hide();\n                window.hascompleted = false;\n                var postid = window.location.hash;\n                if (!window.hascompleted) {\n                    if (postid) {\n                        if ($(postid).closest('li').data('depth') > 0) {\n                            $(postid).closest('.posts-collapse-container').addClass('show').find('.posts-collapse-toggle.collapse-bottom').attr('aria-expanded', 'true');\n                        }\n                        $('html,body').animate({scrollTop: $(postid).offset().top - 60}, 1000);\n                    }\n                    window.hascompleted = true;\n                }\n            }).catch(() => {\n                $('.container :input').prop('disabled', false);\n                $('.article').show();\n                $('#hsuforum-loading-container').hide();\n                $('#hsuforum-overlay-box').hide();\n                throw(\"element did not load in 30 seconds\");\n            });\n\n                // Register post observers and custom spinner events.\n                registerPostsObserver();\n                registerSpinnerEvents();\n\n        }\n    };\n});\n"],"file":"mod_hsuforum_loader.min.js"}