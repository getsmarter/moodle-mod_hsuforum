YUI.add("moodle-mod_hsuforum-article",function(l,e){var i,n,s,r,a,d,u,c,h,t;function o(){o.superclass.constructor.apply(this,arguments)}function m(){m.superclass.constructor.apply(this,arguments)}function f(){f.superclass.constructor.apply(this,arguments)}s={ADD_DISCUSSION:"#newdiscussionform input[type=submit]",ADD_DISCUSSION_TARGET:".hsuforum-add-discussion-target",ALL_FORMS:".hsuforum-reply-wrapper form",CONTAINER:".mod-hsuforum-posts-container",CONTAINER_LINKS:".mod-hsuforum-posts-container a",DISCUSSION:".hsuforum-thread",DISCUSSIONS:".hsuforum-threads-wrapper",DISCUSSION_EDIT:"."+(i="hsuforum-thread-edit"),DISCUSSION_BY_ID:'.hsuforum-thread[data-discussionid="%d"]',DISCUSSION_COUNT:".hsuforum-discussion-count",DISCUSSION_TARGET:".hsuforum-new-discussion-target",DISCUSSION_TEMPLATE:"#hsuforum-discussion-template",DISCUSSION_VIEW:".hsuforum-thread-view",EDITABLE_MESSAGE:"[contenteditable]",FORM:".hsuforum-form",FORM_ADVANCED:".hsuforum-use-advanced",FORM_REPLY_WRAPPER:".hsuforum-reply-wrapper",INPUT_FORUM:'input[name="forum"]',INPUT_MESSAGE:'textarea[name="message"]',INPUT_REPLY:'input[name="reply"]',INPUT_SUBJECT:'input[name="subject"]',LINK_CANCEL:".hsuforum-cancel",NO_DISCUSSIONS:".forumnodiscuss",NOTIFICATION:".hsuforum-notification",OPTIONS_TO_PROCESS:".hsuforum-options-menu.unprocessed",PLACEHOLDER:".thread-replies-placeholder",POSTS:".hsuforum-thread-replies",POST_BY_ID:'.hsuforum-post-target[data-postid="%d"]',POST_EDIT:"."+(n="hsuforum-post-edit"),POST_TARGET:".hsuforum-post-target",RATE:".forum-post-rating",RATE_POPUP:".forum-post-rating a",REPLY_TEMPLATE:"#hsuforum-reply-template",SEARCH_PAGE:"#page-mod-hsuforum-search",VALIDATION_ERRORS:".hsuforum-validation-errors",VIEW_POSTS:".hsuforum-view-posts"},r="discussion:created",a="discussion:deleted",d="form:canceled",u="post:created",c="post:deleted",h="post:updated",M.mod_hsuforum=M.mod_hsuforum||{},o.NAME="moodle-mod_hsuforum-dom",o.ATTRS={io:{value:null}},l.extend(o,l.Base,{initializer:function(){l.all(s.RATE).addClass("processed"),this.initOptionMenus()},initFeatures:function(){this.initOptionMenus(),this.initRatings()},initRatings:function(){l.all(s.RATE).each(function(e){e.hasClass("processed")||(M.core_rating.Y=l,e.all("select.postratingmenu").each(M.core_rating.attach_rating_events,M.core_rating),e.all("input.postratingmenusubmit").setStyle("display","none"),e.addClass("processed"))})},initOptionMenus:function(){l.all(s.OPTIONS_TO_PROCESS).each(function(e){e.removeClass("unprocessed");var t=new l.YUI2.widget.Menu(e.generateID(),{lazyLoad:!0});t.render(l.one(s.CONTAINER).generateID()),l.one("#"+e.getData("controller")).on("click",function(e){e.preventDefault(),t.cfg.setProperty("y",e.currentTarget.getY()+e.currentTarget.get("offsetHeight")),t.cfg.setProperty("x",e.currentTarget.getX()),t.show()})})},handleViewRating:function(e){null===e.currentTarget.ancestor(".helplink")&&(e.preventDefault(),openpopup(e,{url:e.currentTarget.get("href")+"&popup=1",name:"ratings",options:"height=400,width=600,top=0,left=0,menubar=0,location=0,scrollbars,resizable,toolbar,status,directories=0,fullscreen=0,dependent"}))},markPostAsRead:function(e,t,o){this.get("io").send({postid:e,action:"markread"},t,o)},incrementDiscussionCount:function(e){var t=l.one(s.DISCUSSION_COUNT);null!==t&&(t.setData("count",parseInt(t.getData("count"),10)+e),t.setHTML(M.util.get_string("xdiscussions","mod_hsuforum",t.getData("count"))))},displayNotification:function(e){var t=l.Node.create(e);l.one(s.NOTIFICATION).append(t),setTimeout(function(){t.remove(!0)},1e4)},handleNotification:function(e){l.Lang.isString(e.notificationhtml)&&0<e.notificationhtml.trim().length&&this.displayNotification(e.notificationhtml)},handleUpdateDiscussion:function(e){var t=l.one("#discussionsview");t?t.setHTML(e.html):(t=l.one(s.DISCUSSION_BY_ID.replace("%d",e.discussionid)))?(t.replace(e.html),this.initRatings()):l.one(s.DISCUSSION_TARGET).insert(e.html,"after")},handleDiscussionCreated:function(){l.one(s.NO_DISCUSSIONS)&&l.one(s.NO_DISCUSSIONS).remove(),location.reload()},handleDiscussionDeleted:function(e){var t=l.one(s.POST_BY_ID.replace("%d",e.postid));null!==t&&t.hasAttribute("data-isdiscussion")&&(l.one(s.DISCUSSIONS)?(t.remove(!0),this.incrementDiscussionCount(-1),l.one(s.DISCUSSION_COUNT).focus()):window.location.href=e.redirecturl)}}),M.mod_hsuforum.Dom=o,t=l.Base.create("hsuforumRouter",l.Router,[],{initializer:function(){},discussion:function(e){this.get("article").viewDiscussion(e.query.d,e.query.postid)},post:function(e){l.Lang.isUndefined(e.query.reply)?l.Lang.isUndefined(e.query.forum)?l.Lang.isUndefined(e.query["delete"])?l.Lang.isUndefined(e.query.edit)?l.Lang.isUndefined(e.query.prune)||(window.location.href=e.url):this.get("article").get("form").showEditForm(e.query.edit):this.get("article").confirmDeletePost(e.query["delete"]):this.get("article").get("form").showAddDiscussionForm(e.query.forum):this.get("article").get("form").showReplyToForm(e.query.reply)},focusHash:function(e){var t=e.get("href").split("#");setTimeout(function(){try{l.one("#"+t[1]).ancestor("li").focus()}catch(e){}},300)},handleRoute:function(e){1!==e.button||e.ctrlKey||e.metaKey||e.currentTarget.hasClass("disable-router")||e.currentTarget.hasClass("autolink")||e.currentTarget.ancestor(".posting")?-1<e.currentTarget.get("href").indexOf("#")&&this.focusHash(e.currentTarget):(M.mod_hsuforum.restoreEditor(),this.routeUrl(e.currentTarget.get("href"))&&e.preventDefault())},routeUrl:function(e){return!!this.hasRoute(e)&&(this.save(this.removeRoot(e)),!0)},handleAddDiscussionRoute:function(e){var t;e.preventDefault(),M.mod_hsuforum.restoreEditor(),"undefined"!=typeof e.currentTarget&&(t=(e=e.currentTarget.ancestor("form")).one(s.INPUT_FORUM).get("value"),this.save(e.get("action")+"?forum="+t))},handleViewDiscussion:function(e){var t="/discuss.php?d="+e.discussionid;l.Lang.isUndefined(e.postid)||(t=t+"&postid="+e.postid),this.save(t)},hideForms:function(e,t,o){this.get("article").get("form"
).restoreDateFields(),this.get("article").get("form").removeAllForms(),o()}},{ATTRS:{article:{value:null},root:{valueFn:function(){return M.cfg.wwwroot.replace(this._regexUrlOrigin,"")+"/mod/hsuforum"}},routes:{value:[{path:"/view.php",callbacks:["hideForms"]},{path:"/discuss.php",callbacks:["hideForms","discussion"]},{path:"/post.php",callbacks:["hideForms","post"]}]}}}),M.mod_hsuforum.Router=t,m.NAME="moodle-mod_hsuforum-form",m.ATTRS={io:{value:null}},l.extend(m,l.Base,{handleFormPaste:function(s){var e,t,o,i,n="",r=window.getSelection(),a=function(e){var t,o,i=document.createElement("div");for(i.innerHTML=e,t=0,o=(tags=i.getElementsByTagName("*")).length;t<o;t++)tags[t].removeAttribute("id"),tags[t].removeAttribute("style"),tags[t].removeAttribute("size"),tags[t].removeAttribute("color"),tags[t].removeAttribute("bgcolor"),tags[t].removeAttribute("face"),tags[t].removeAttribute("align");return i.innerHTML},d=!1;if(s._event&&s._event.clipboardData&&s._event.clipboardData.getData?d=s._event.clipboardData:window.clipboardData&&window.clipboardData.getData&&(d=window.clipboardData),d&&(d.types?/text\/html/.test(d.types)||d.types.contains("text/html")?n=d.getData("text/html"):(/text\/plain/.test(d.types)||d.types.contains("text/plain"))&&(n=d.getData("text/plain")):n=d.getData("Text"),""!==n)){if(r.getRangeAt&&r.rangeCount){for(e=r.getRangeAt(0),(t=document.createElement("p")).innerHTML=a(n),"META"===t.childNodes[0].tagName&&t.removeChild(t.childNodes[0]),d=t.childNodes[t.childNodes.length-1],o=0;o<=t.childNodes.length;o++)i=t.childNodes[t.childNodes.length-1],e.insertNode(i);e.setStartAfter(d),e.setEndAfter(d),r.removeAllRanges(),r.addRange(e)}return s._event.preventDefault&&(s._event.stopPropagation(),s._event.preventDefault()),!1}setTimeout(function(){var e,i,t,o,n=a(s.currentTarget.get("innerHTML"));s.currentTarget.setContent(n),n=document.createRange(),e=window.getSelection(),o=1,o=("undefined"!=typeof(t=(i=function(e){var t,o=e.childNodes;return!!o&&((o=o[o.length-1])&&void 0!==o?(t=i(o))&&void 0!==t?t:o&&void 0!==o?o:e:e)})(s.currentTarget._node)).innerHTML?t.innerHTML:t).length,n.setStart(t,o),n.collapse(!0),e.removeAllRanges(),e.addRange(n)},100)},handlePostToGroupsToggle:function(e){var t=e.currentTarget.ancestor("form").one("#menugroupinfo");e.currentTarget.get("checked")?t.set("disabled","disabled"):t.set("disabled","")},handleTimeToggle:function(e){e.currentTarget.get("checked")?e.currentTarget.ancestor(".fdate_selector").all("select").set("disabled",""):e.currentTarget.ancestor(".fdate_selector").all("select").set("disabled","disabled")},_displayReplyForm:function(e){var t=l.one(s.REPLY_TEMPLATE).getHTML(),o=e.one(s.FORM_REPLY_WRAPPER);o instanceof l.Node?o.replace(t):e.append(t),o=e.one(s.FORM_REPLY_WRAPPER),this.attachFormWarnings(),o.one(s.INPUT_REPLY).setAttribute("value",e.getData("postid")),(t=o.one(s.FORM_ADVANCED)).setAttribute("href",t.getAttribute("href").replace(/reply=\d+/,"reply="+e.getData("postid"))),e.hasAttribute("data-ispost")&&o.one("legend").setHTML(M.util.get_string("replytox","mod_hsuforum",e.getData("author")))},_copyMessage:function(e){var t=e.one(s.EDITABLE_MESSAGE).get("innerHTML");e.one(s.INPUT_MESSAGE).set("value",t)},_submitReplyForm:function(t,o){var e,i;t.all("button").setAttribute("disabled","disabled"),this._copyMessage(t),e=t.all("form input[type=file]"),(i=l.one("#hiddenadvancededitordraftid"))&&((i=i.cloneNode()).id="hiddenadvancededitordraftidclone",t.one("form input").insert(i,"before")),this.get("io").submitForm(t.one("form"),function(e){e.yuiformsubmit=1,!0===e.errors?(t.one(s.VALIDATION_ERRORS).setHTML(e.html).addClass("notifyproblem"),t.all("button").removeAttribute("disabled")):o.call(this,e)},this,0<e._nodes.length)},attachFormWarnings:function(){l.all(s.ALL_FORMS).each(function(e){var t,o;e.hasClass("form-checker-added")||(o=(t=require("core_form/changechecker")).watchFormById(e.generateID()),e.addClass("form-checker-added"),e.one(s.EDITABLE_MESSAGE).on("keypress",t.markAllFormsAsDirty,o))})},removeAllForms:function(){},handleCancelForm:function(e){e.preventDefault(),this.restoreDateFields(),M.mod_hsuforum.restoreEditor();var t=e.target.ancestor(s.POST_TARGET);t?(t.removeClass(n).removeClass(i),e.target.ancestor(s.FORM_REPLY_WRAPPER).remove(!0),this.fire(d,{discussionid:t.getData("discussionid"),postid:t.getData("postid")})):(t=e.target.ancestor(s.ADD_DISCUSSION_TARGET),e.target.ancestor(s.FORM_REPLY_WRAPPER).remove(!0))},handleFormSubmit:function(e){e.preventDefault(),M.mod_hsuforum.restoreEditor();e=e.currentTarget.ancestor(s.FORM_REPLY_WRAPPER);this._submitReplyForm(e,function(e){switch(this.restoreDateFields(),e.eventaction){case"postupdated":case"postcreated":this.fire(h,e);break;case"discussioncreated":this.fire(r,e)}})},showReplyToForm:function(e){e=l.one(s.POST_BY_ID.replace("%d",e));e.hasAttribute("data-ispost")&&this._displayReplyForm(e),e.one(s.EDITABLE_MESSAGE).focus()},setDateField:function(e,t,o){var o=new Date(1e3*o),i=o.getDate(),n=o.getMonth()+1,o=o.getFullYear();t?l.one("#id_time"+e+"_enabled").set("checked","checked"):l.one("#id_time"+e+"_enabled").removeAttribute("checked"),l.one("#id_time"+e+"_day").set("value",i),l.one("#id_time"+e+"_month").set("value",n),l.one("#id_time"+e+"_year").set("value",o),this.setDateFieldsClassState()},resetDateField:function(e){var t;l.one("#discussion_dateform fieldset")&&(t=Math.floor(Date.now()/1e3),this.setDateField(e,!1,t))},resetDateFields:function(){var e,t=["start","end"];for(e in t)this.resetDateField(t[e])},setDateFieldsClassState:function(){var e=l.one("fieldset.dateform_fieldset");e&&e.all(".fdate_selector").each(function(e){e.one("input").get("checked")?e.all("select").set("disabled",""):e.all("select").set("disabled","disabled")})},applyDateFields:function(){var e=l.one("#discussion_dateform fieldset");e&&(e.addClass("dateform_fieldset"),e.removeClass("hidden"),e.one("legend")&&e.one("legend").remove(),l.one(".dateformtarget").append(e),l.all(
".dateformtarget .fitem_fdate_selector a").addClass("disable-router"),this.setDateFieldsClassState())},setDateFields:function(e,t){0==e?this.resetDateField("start"):this.setDateField("start",!0,e),0==t?this.resetDateField("end"):this.setDateField("end",!0,t)},restoreDateFields:function(){l.one("#discussion_dateform")&&l.one("#discussion_dateform").append(l.one(".dateform_fieldset"))},showAddDiscussionForm:function(){l.one(s.ADD_DISCUSSION_TARGET).setHTML(l.one(s.DISCUSSION_TEMPLATE).getHTML()).one(s.INPUT_SUBJECT).focus(),this.resetDateFields(),this.applyDateFields(),this.attachFormWarnings()},showEditForm:function(e){var t,o=l.one(s.POST_BY_ID.replace("%d",e));o.hasClass(i)||o.hasClass(n)?o.one(s.EDITABLE_MESSAGE).focus():(t=this,e=l.one("#hiddenadvancededitordraftid"),this.get("io").send({discussionid:o.getData("discussionid"),postid:o.getData("postid"),draftid:e?e.get("value"):0,action:"edit_post_form"},function(e){o.prepend(e.html),o.hasAttribute("data-isdiscussion")?o.addClass(i):o.addClass(n),o.one(s.EDITABLE_MESSAGE).focus(),e.isdiscussion&&(t.applyDateFields(),t.setDateFields(e.timestart,e.timeend)),this.attachFormWarnings()},this))}}),M.mod_hsuforum.Form=m,f.NAME=e,f.ATTRS={contextId:{value:undefined},io:{readOnly:!0},dom:{readOnly:!0},router:{readOnly:!0},form:{readOnly:!0},liveLog:{readOnly:!0},editorMutateObserver:null,currentEditLink:null},l.extend(f,l.Base,{initializer:function(){this._set("router",new M.mod_hsuforum.Router({article:this,html5:!1})),this._set("io",new M.mod_hsuforum.Io({contextId:this.get("contextId")})),this._set("dom",new M.mod_hsuforum.Dom({io:this.get("io")})),this._set("form",new M.mod_hsuforum.Form({io:this.get("io")})),this._set("liveLog",M.mod_hsuforum.init_livelog()),this.bind()},bind:function(){var e,t,o,i,n=document.getElementsByClassName("hsuforum-post-unread")[0];if(n&&"#unread"===location.hash){if(n=document.getElementById(n.id).parentNode,navigator.userAgent.match(/Trident|MSIE/)){for(e=n.offsetTop,t=n;t=t.offsetParent;)e+=t.offsetTop;window.scrollTo(0,e)}else n.scrollIntoView();n.focus()}null===l.one(s.SEARCH_PAGE)&&(n=this.get("dom"),o=this.get("form"),i=this.get("router"),l.delegate("paste",o.handleFormPaste,document,".hsuforum-textarea",o),l.delegate("click",o.handlePostToGroupsToggle,document,'.hsuforum-discussion input[name="posttomygroups"]',o),l.delegate("click",o.handleTimeToggle,document,".hsuforum-discussion .fdate_selector input",o),l.delegate("click",o.handleCancelForm,document,s.LINK_CANCEL,o),l.delegate("click",i.handleRoute,document,s.CONTAINER_LINKS,i),l.delegate("click",n.handleViewRating,document,s.RATE_POPUP,n),l.delegate("click",function(e){var t,o,i=l.one("#hiddenadvancededitorcont"),n=this;i&&(e.preventDefault(),t=l.one("#hiddenadvancededitoreditable"),t.ancestor(".editor_atto")?M.mod_hsuforum.toggleAdvancedEditor(n):(n.setContent(M.util.get_string("loadingeditor","hsuforum")),o=setInterval(function(){t.ancestor(".editor_atto")&&(clearInterval(o),M.mod_hsuforum.toggleAdvancedEditor(n))},500)))},document,".hsuforum-use-advanced"),l.delegate("submit",o.handleFormSubmit,document,s.FORM,o),l.delegate("click",i.handleAddDiscussionRoute,document,s.ADD_DISCUSSION,i),o.on(u,n.handleUpdateDiscussion,n),o.on(u,n.handleNotification,n),o.on(u,i.handleViewDiscussion,i),o.on(u,this.handleLiveLog,this),o.on(h,this.handlePostUpdated,this),o.on(r,n.handleUpdateDiscussion,n),o.on(r,n.handleDiscussionCreated,n),o.on(r,n.handleNotification,n),o.on(r,i.handleViewDiscussion,i),o.on(r,this.handleLiveLog,this),this.on(a,n.handleDiscussionDeleted,n),this.on(a,n.handleNotification,n),this.on(a,this.handleLiveLog,this),this.on(c,n.handleUpdateDiscussion,n),this.on(c,i.handleViewDiscussion,i),this.on(c,n.handleNotification,n),this.on(c,this.handleLiveLog,this),o.on(d,i.handleViewDiscussion,i))},handlePostUpdated:function(e){var t=this.get("dom"),o=this.get("form"),i=this.get("router");o.restoreDateFields(),t.handleUpdateDiscussion(e),i.handleViewDiscussion(e),t.handleNotification(e),this.handleLiveLog(e)},handleLiveLog:function(e){l.Lang.isString(e.livelog)&&this.get("liveLog").logText(e.livelog)},viewDiscussion:function(e,t){e=l.one(s.DISCUSSION_BY_ID.replace("%d",e));e instanceof l.Node&&(l.Lang.isUndefined(t)||null===(t=l.one(s.POST_BY_ID.replace("%d",t)))||t.hasAttribute("data-isdiscussion")?e:t.get("parentNode")).focus()},confirmDeletePost:function(e){null!==l.one(s.POST_BY_ID.replace("%d",e))&&!0===window.confirm(M.str.mod_hsuforum.deletesure)&&this.deletePost(e)},deletePost:function(e){var t=l.one(s.POST_BY_ID.replace("%d",e));null!==t&&this.get("io").send({postid:e,sesskey:M.cfg.sesskey,action:"delete_post"},function(e){t.hasAttribute("data-isdiscussion")?this.fire(a,e):this.fire(c,e)},this)}}),M.mod_hsuforum.Article=f,M.mod_hsuforum.init_article=function(e){new f(e)},M.mod_hsuforum.dispatchClick=function(e){var t;document.createEvent?(t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0}),e.dispatchEvent(t)):e.fireEvent&&e.fireEvent("onclick")},M.mod_hsuforum.restoreEditor=function(){var e,t,o,i;l.one("#hiddenadvancededitorcont")&&(e=l.one("#hiddenadvancededitoreditable"))&&(t=e.ancestor(".editor_atto"),i=!1,(o=M.mod_hsuforum.Article.currentEditLink)&&(i=o.previous(".hsuforum-textarea")),t&&"none"!==t.getComputedStyle("display"))&&(t.one(".atto_html_button.highlight")&&M.mod_hsuforum.dispatchClick(t.one(".atto_html_button.highlight")._node),i)&&i.setContent(e.getContent())},M.mod_hsuforum.toggleAdvancedEditor=function(e,t,o){var i,n,s,r,a,d,u=!1;if(t||(u=e&&"false"===e.getAttribute("aria-pressed")),e&&(M.mod_hsuforum.Article.currentEditLink=e,u?e.removeClass("hideadvancededitor"):e.addClass("hideadvancededitor")),t){if(!e){for(i=l.all(".hsuforum-use-advanced"),n=0;n<i.size();n++)s=i.item(n),o&&o===s||M.mod_hsuforum.toggleAdvancedEditor(s,!0);return}}else M.mod_hsuforum.toggleAdvancedEditor(!1,!0,e);if(t=l.one("#hiddenadvancededitorcont"),a=e.previous(".hsuforum-textarea"),!t)throw"Failed to get editor";t=(r=l.one(
"#hiddenadvancededitoreditable")).ancestor(".editor_atto"),a&&r.setStyle("height",a.getDOMNode().offsetHeight+"px"),d=!1,t&&"none"!==t.getComputedStyle("display")||(d=!0),u?(e.setAttribute("aria-pressed","true"),e.setContent(M.util.get_string("hideadvancededitor","hsuforum")),a.hide(),t.one(".atto_html_button.highlight")&&l.one("#hiddenadvancededitor").show(),t.show(),a.insert(t,"before"),a.insert(l.one("#hiddenadvancededitor"),"before"),(u=l.one("#hiddenadvancededitordraftid"))&&((u=u.cloneNode()).id="hiddenadvancededitordraftidclone",a.insert(u,"before")),r.setContent(a.getContent()),r.focus(),window.MutationObserver?(M.mod_hsuforum.Article.editorMutateObserver=new MutationObserver(function(){a.setContent(r.getContent())}),M.mod_hsuforum.Article.editorMutateObserver.observe(r.getDOMNode(),{childList:!0,characterData:!0,subtree:!0})):r.getDOMNode().addEventListener("DOMCharacterDataModified",editAreachanged,!1)):(e.setAttribute("aria-pressed","false"),M.mod_hsuforum.Article.editorMutateObserver&&M.mod_hsuforum.Article.editorMutateObserver.disconnect(),e.setContent(M.util.get_string("useadvancededitor","hsuforum")),a.show(),d||(t.one(".atto_html_button.highlight")&&M.mod_hsuforum.dispatchClick(t.one(".atto_html_button.highlight")._node),a.setContent(r.getContent())),l.one("#hiddenadvancededitor").hide(),t.hide())}},"@VERSION@",{requires:["base","node","event","router","core_rating","querystring","moodle-mod_hsuforum-io","moodle-mod_hsuforum-livelog","moodle-core-formchangechecker"]});